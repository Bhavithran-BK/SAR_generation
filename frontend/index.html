<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAR Generator - Compliance Portal</title>
    <style>
        :root {
            --barclays-blue: #00AEEF;
            --barclays-dark: #00395D;
            --success-green: #28a745;
            --warning-amber: #ffc107;
            --danger-red: #dc3545;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: #f4f7f6;
            color: #333;
            overflow-x: hidden;
        }

        /* Login Overlay */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--barclays-dark);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            width: 350px;
            color: #333;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        .login-box h2 {
            margin-top: 0;
            color: var(--barclays-dark);
            text-align: center;
        }

        .login-box input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }

        /* Layout */
        .main-container {
            display: flex;
            height: 100vh;
        }

        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            transition: margin-right 0.3s;
        }

        /* Sidebar Panel */
        .side-panel {
            width: 0;
            background: white;
            border-left: 1px solid #ddd;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            transition: width 0.3s;
            position: fixed;
            right: 0;
            top: 0;
            height: 100%;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .side-panel.open {
            width: 500px;
        }

        .panel-header {
            background: var(--barclays-dark);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h2 {
            margin: 0;
            font-size: 1.2rem;
        }

        .close-panel {
            cursor: pointer;
            font-size: 1.2rem;
            color: white;
            background: none;
            border: none;
        }

        .panel-content {
            padding: 20px;
            flex-grow: 1;
        }

        .panel-section {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .panel-section h3 {
            margin-top: 0;
            color: var(--barclays-blue);
            font-size: 1rem;
            border-bottom: 2px solid var(--barclays-blue);
            padding-bottom: 5px;
            display: inline-block;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
        }

        .info-label {
            color: #666;
            font-weight: 500;
        }

        .info-value {
            font-weight: bold;
            color: #333;
        }

        /* Transaction List */
        .tx-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .tx-item {
            padding: 10px;
            border: 1px solid #eee;
            margin-bottom: 8px;
            border-radius: 6px;
            background: #fafafa;
            font-size: 0.85rem;
            display: flex;
            gap: 10px;
            align-items: flex-start;
            cursor: pointer;
        }

        .tx-item:hover {
            background: #f0f8ff;
        }

        .tx-item.p-high {
            border-left: 4px solid var(--danger-red);
        }

        .tx-details {
            flex-grow: 1;
        }

        .tx-amount {
            font-weight: bold;
            display: block;
        }

        .tx-date {
            color: #888;
            font-size: 0.75rem;
        }

        /* General UI */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 3px solid var(--barclays-blue);
            padding-bottom: 10px;
        }

        h1 {
            color: var(--barclays-dark);
            margin: 0;
            font-size: 2.2rem;
        }

        .simulation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .sim-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 20px;
            transition: transform 0.2s;
            border: 1px solid #eee;
        }

        .sim-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .btn {
            background: var(--barclays-blue);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
            transition: background 0.2s;
        }

        .btn:hover:not(:disabled) {
            background: #009cd6;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-panel {
            margin-top: auto;
            border-top: 1px solid #ccc;
            padding: 15px;
            background: #f9f9f9;
        }

        /* Overlays */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 101;
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            width: 85%;
            height: 90%;
            z-index: 102;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        #edit-area {
            flex-grow: 1;
            margin: 15px 0;
            padding: 25px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 1.05rem;
            line-height: 1.7;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            resize: none;
            background: #fdfdfd;
            white-space: pre-wrap;
            color: #2c3e50;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            background: none;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: var(--barclays-dark);
            border-bottom: 3px solid var(--barclays-blue);
            font-weight: bold;
        }
    </style>
</head>

<body>

    <!-- Login Overlay -->
    <div id="login-overlay">
        <div style="margin-bottom: 20px; text-align: center;">
            <h1 style="color: white; border:none; margin-bottom:5px;">BARCLAYS</h1>
            <div style="font-size: 1.2rem; opacity: 0.8;">Compliance Audit System</div>
        </div>
        <div class="login-box">
            <h2>Sign In</h2>
            <input type="text" id="username" placeholder="Username (officer or auditor)" value="officer">
            <input type="password" id="password" placeholder="Password" value="password">
            <button class="btn" onclick="handleLogin()">Login</button>
            <div style="margin-top: 15px; font-size: 0.8rem; color: #777; text-align: center;">
                Use <b>officer</b> or <b>auditor</b> to sign in.
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="content-area">
            <div style="max-width: 1200px; margin: 0 auto;">
                <header>
                    <h1>SAR <span style="font-weight: 300; color: var(--barclays-blue);">Audit Workflow</span></h1>
                    <div style="display:flex; gap:20px; align-items:center;">
                        <div id="role-badge" class="badge" style="background:var(--barclays-blue); color:white;">OFFICER
                        </div>
                        <button onclick="handleLogout()"
                            style="background:none; border:1px solid #ccc; padding:5px 10px; border-radius:4px; cursor:pointer;">Logout</button>
                    </div>
                </header>

                <div class="tabs" id="main-tabs">
                    <button class="tab active" data-role="OFFICER" onclick="switchTab('discovery')">Case
                        Discovery</button>
                    <button class="tab" data-role="AUDITOR" onclick="switchTab('audit-queue')">Audit Queue</button>
                    <button class="tab" onclick="switchTab('history')">Submitted History</button>
                </div>

                <!-- Views -->
                <div id="view-discovery" class="view-section">
                    <div id="sim-grid" class="simulation-grid"></div>
                </div>

                <div id="view-audit-queue" class="view-section" style="display:none;">
                    <div id="audit-list" class="history-list"></div>
                </div>

                <div id="view-history" class="view-section" style="display:none;">
                    <div id="history-list" class="history-list"></div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="side-panel" id="side-panel">
            <div class="panel-header">
                <h2 id="panel-title">Case Investigation</h2>
                <button class="close-panel" onclick="closePanel()">×</button>
            </div>
            <div class="panel-content" id="panel-details"></div>
            <div class="btn-panel" id="action-panel" style="display:none;">
                <div id="generation-status"
                    style="margin-bottom:10px; font-weight:bold; font-size:0.9rem; text-align:center;"></div>
                <button class="btn" id="btn-generate" onclick="triggerGeneration()">Generate AI Report</button>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="overlay" id="overlay" onclick="closeModal()"></div>
    <div class="modal" id="review-modal" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="modal-title">Report Review</h2>
            <button onclick="closeModal()"
                style="background:none; border:none; font-size:1.5rem; cursor:pointer;">×</button>
        </div>
        <div id="modal-desc" style="color:#666; font-size:0.9rem; margin-bottom:10px;"></div>

        <div id="audit-trail"
            style="background:#f8f9fa; padding:10px; border-radius:4px; font-size:0.8rem; display:none; margin-bottom:10px;">
        </div>

        <textarea id="edit-area"></textarea>

        <div id="modal-actions" style="display:flex; gap:15px; justify-content:flex-end;"></div>
    </div>

    <script>
        let currentUser = null;
        let currentCase = null;
        let selectedTxIds = new Set();
        let activeSarId = null;

        const API_URL = "http://localhost:8000/api/v1";
        const API_KEY = "barclays-hackathon-secret-key";

        // --- AUTH ---
        async function handleLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;

            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: u, password: p })
                });

                if (!res.ok) throw new Error("Invalid login");

                currentUser = await res.json();
                document.getElementById('login-overlay').style.display = 'none';
                initDashboard();
            } catch (e) {
                alert(e.message);
            }
        }

        function handleLogout() {
            currentUser = null;
            document.getElementById('login-overlay').style.display = 'flex';
        }

        function initDashboard() {
            document.getElementById('role-badge').innerText = currentUser.role;
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => {
                const role = t.getAttribute('data-role');
                if (role && role !== currentUser.role) {
                    t.style.display = 'none';
                } else {
                    t.style.display = 'block';
                }
            });

            if (currentUser.role === 'OFFICER') {
                switchTab('discovery');
            } else {
                switchTab('audit-queue');
            }
        }

        // --- TABS ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const activeTab = Array.from(document.querySelectorAll('.tab')).find(t => t.innerText.toLowerCase().includes(tabName.split('-')[0]));
            if (activeTab) activeTab.classList.add('active');

            document.querySelectorAll('.view-section').forEach(v => v.style.display = 'none');
            document.getElementById(`view-${tabName}`).style.display = 'block';

            if (tabName === 'discovery') loadCases();
            if (tabName === 'audit-queue') loadAuditQueue();
            if (tabName === 'history') loadHistory();
        }

        // --- DATA LOADERS ---
        async function loadCases() {
            const res = await fetch(`${API_URL}/cases`, { headers: { "X-API-Key": API_KEY } });
            const data = await res.json();
            const grid = document.getElementById('sim-grid');
            grid.innerHTML = data.cases.map(c => `
                <div class="sim-card">
                    <div class="card-header"><strong>${c.account_number}</strong><span class="badge" style="${getRiskStyle(c.risk_rating)}">${c.risk_rating}</span></div>
                    <h3>${c.customer_name}</h3>
                    <p style="font-size:0.9rem; color:#666;">${c.typology}</p>
                    <button class="btn" onclick="openCase('${c.account_number}')">Inspect & Generate</button>
                </div>
            `).join('');
        }

        async function loadAuditQueue() {
            const res = await fetch(`${API_URL}/cases/history/submitted`, { headers: { "X-API-Key": API_KEY } });
            const data = await res.json();
            // In a real app, Auditor only sees VERIFIED. For demo, we filter or show all based on status.
            const verified = data.filter(r => r.status === 'VERIFIED');
            const list = document.getElementById('audit-list');
            list.innerHTML = verified.length ? verified.map(r => `
                <div class="tx-item" style="background:white; padding:15px;" onclick="openAuditReport('${r.sar_id}')">
                    <div class="tx-details">
                        <strong>${r.sar_id}</strong> - Case ${r.account_number}
                        <div style="font-size:0.8rem; color:#666;">Verified by Officer at ${new Date(r.submitted_at).toLocaleString()}</div>
                    </div>
                    <button class="btn" style="width:auto;">Review & Finalize</button>
                </div>
            `).join('') : '<p style="text-align:center; padding:40px; color:#666;">No reports pending audit.</p>';
        }

        async function loadHistory() {
            const res = await fetch(`${API_URL}/cases/history/submitted`, { headers: { "X-API-Key": API_KEY } });
            const data = await res.json();
            const list = document.getElementById('history-list');
            list.innerHTML = data.map(r => `
                <div class="tx-item" style="background:white; padding:15px;" onclick="viewFinalReport('${r.sar_id}')">
                    <div class="tx-details">
                        <strong>${r.sar_id}</strong> - ${r.account_number}
                        <div style="font-size:0.8rem; color:#666;">Status: <span style="font-weight:bold; color:var(--barclays-blue);">${r.status}</span></div>
                    </div>
                    <button class="btn" style="width:auto;">View</button>
                </div>
            `).join('');
        }

        // --- SIDEBAR & GENERATION ---
        async function openCase(accNum) {
            document.getElementById('side-panel').classList.add('open');
            const res = await fetch(`${API_URL}/cases/${accNum}`, { headers: { "X-API-Key": API_KEY } });
            currentCase = await res.json();
            const customer = currentCase.customer;
            selectedTxIds = new Set(currentCase.transactions.map(t => t.transaction_id));

            document.getElementById('panel-details').innerHTML = `
                <div class="panel-section">
                    <h3>Context Anonymization Active</h3>
                    <p style="font-size:0.8rem; color:#666; background:#fff8e1; padding:8px; border-radius:4px;">
                        PII (Name, ID) is stripped before AI analysis to ensure privacy.
                    </p>
                    <div class="info-grid">
                        <span class="info-label">Acc Type:</span> <span>${customer.account_number.startsWith('IN') ? 'India Savings' : 'Standard'}</span>
                        <span class="info-label">Risk Rating:</span> <span style="${getRiskStyle(customer.risk_rating)}">${customer.risk_rating}</span>
                    </div>
                </div>
                <div class="panel-section">
                    <h3>Transactions</h3>
                    <ul class="tx-list">
                        ${currentCase.transactions.map(tx => `
                            <li class="tx-item ${tx.is_anomaly ? 'p-high' : ''}">
                                <div class="tx-details">
                                    <span class="tx-amount">₹${tx.amount.toLocaleString()}</span>
                                    <span class="tx-date">${new Date(tx.timestamp).toLocaleDateString()} - ${tx.transaction_type}</span>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
            document.getElementById('action-panel').style.display = 'block';
            document.getElementById('btn-generate').disabled = false;
        }

        async function triggerGeneration() {
            const btn = document.getElementById('btn-generate');
            const status = document.getElementById('generation-status');
            btn.disabled = true;
            status.innerHTML = `<span class="status-generating">Anonymizing & Running Deep AI Analysis...</span>`;

            const filteredTx = currentCase.transactions.filter(t => selectedTxIds.has(t.transaction_id));
            const requestPayload = {
                customer: currentCase.customer,
                transactions: filteredTx,
                alerts: currentCase.alerts,
                region: "IND",
                typology: currentCase.typology
            };

            try {
                console.log("Submitting generation request...", requestPayload);
                const res = await fetch(`${API_URL}/generation/generate`, {
                    method: 'POST',
                    headers: { "Content-Type": "application/json", "X-API-Key": API_KEY },
                    body: JSON.stringify(requestPayload)
                });

                const job = await res.json();
                console.log("Generation response:", job);

                if (res.ok && job.job_id) {
                    pollJob(job.job_id);
                } else {
                    const errorMsg = job.detail ? JSON.stringify(job.detail) : (job.message || "Unknown error");
                    throw new Error(errorMsg);
                }
            } catch (e) {
                console.error("Generation Trigger Failed:", e);
                status.innerHTML = `<span class="status-error">Submission Failed: ${e.message}</span>`;
                btn.disabled = false;
            }
        }

        function pollJob(jobId) {
            console.log("Starting polling for Job ID:", jobId);
            const interval = setInterval(async () => {
                try {
                    const res = await fetch(`${API_URL}/generation/status/${jobId}`, { headers: { "X-API-Key": API_KEY } });
                    const data = await res.json();
                    console.log(`Polling status for ${jobId}:`, data.status);

                    if (data.status === 'COMPLETED') {
                        clearInterval(interval);
                        document.getElementById('generation-status').innerHTML = `<span class="status-done">Analysis Finished.</span>`;
                        document.getElementById('btn-generate').disabled = false;
                        showOfficerReview(data.result);
                    } else if (data.status === 'FAILED') {
                        clearInterval(interval);
                        document.getElementById('generation-status').innerHTML = `<span class="status-error">AI Task Failed: ${data.error || 'Unknown Error'}</span>`;
                        document.getElementById('btn-generate').disabled = false;
                    }
                } catch (e) {
                    console.error("Polling Error:", e);
                }
            }, 3000);
        }

        // --- MODALS & WORKFLOWS ---
        function showOfficerReview(result) {
            activeSarId = result.sar_id;
            document.getElementById('edit-area').value = result.content;
            document.getElementById('edit-area').readOnly = false;
            document.getElementById('modal-title').innerText = "Officer Review & Verification";
            document.getElementById('modal-desc').innerText = "Step 1: Cleanup the AI narrative. Use the 'Verify' button to hand-off to Audit.";
            document.getElementById('audit-trail').style.display = 'none';
            document.getElementById('modal-actions').innerHTML = `
                <button class="btn" style="background:#6c757d; width:auto;" onclick="closeModal()">Discard</button>
                <button class="btn" style="background:var(--success-green); width:auto;" onclick="handleVerify()">Verify & Send to Audit</button>
            `;
            document.getElementById('review-modal').style.display = 'flex';
            document.getElementById('overlay').style.display = 'block';
        }

        async function openAuditReport(sarId) {
            const res = await fetch(`${API_URL}/cases/history/${sarId}`, { headers: { "X-API-Key": API_KEY } });
            const sar = await res.json();
            activeSarId = sar.sar_id;
            document.getElementById('edit-area').value = sar.edited_content || sar.content;
            document.getElementById('edit-area').readOnly = true; // Auditor doesn't edit usually
            document.getElementById('modal-title').innerText = "Auditor Final Approval";
            document.getElementById('modal-desc').innerText = "Step 2: Review officer's verified report. Click 'Finalize' to archive for submission.";
            document.getElementById('audit-trail').style.display = 'block';
            document.getElementById('audit-trail').innerHTML = `<b>OFFICER VERIFIED:</b> ${sar.officer_id || 'System'} at ${new Date().toLocaleString()}`;
            document.getElementById('modal-actions').innerHTML = `
                <button class="btn" style="background:#6c757d; width:auto;" onclick="closeModal()">Back</button>
                <button class="btn" style="background:var(--barclays-dark); width:auto;" onclick="handleFinalize()">Finalize Report</button>
            `;
            document.getElementById('review-modal').style.display = 'flex';
            document.getElementById('overlay').style.display = 'block';
        }

        async function viewFinalReport(sarId) {
            const res = await fetch(`${API_URL}/cases/history/${sarId}`, { headers: { "X-API-Key": API_KEY } });
            const sar = await res.json();
            document.getElementById('edit-area').value = sar.edited_content || sar.content;
            document.getElementById('edit-area').readOnly = true;
            document.getElementById('modal-title').innerText = `Final Report: ${sarId}`;
            document.getElementById('modal-desc').innerText = `Status: ${sar.status}`;
            document.getElementById('audit-trail').style.display = 'block';
            document.getElementById('audit-trail').innerHTML = `Officer: ${sar.officer_id} | Auditor: ${sar.auditor_id || 'Pending'}`;
            document.getElementById('modal-actions').innerHTML = `<button class="btn" onclick="closeModal()">Close</button>`;
            document.getElementById('review-modal').style.display = 'flex';
            document.getElementById('overlay').style.display = 'block';
        }

        async function handleVerify() {
            const c = document.getElementById('edit-area').value;
            // First save edits using POST body for reliability
            await fetch(`${API_URL}/generation/save/${activeSarId}`, {
                method: 'POST',
                headers: {
                    "Content-Type": "application/json",
                    "X-API-Key": API_KEY
                },
                body: JSON.stringify({ edited_content: c })
            });
            // Then verify
            await fetch(`${API_URL}/generation/verify/${activeSarId}?officer_id=${currentUser.username}`, { method: 'POST', headers: { "X-API-Key": API_KEY } });
            alert("Sent to Auditor queue.");
            closeModal();
            loadCases();
        }

        async function handleFinalize() {
            await fetch(`${API_URL}/generation/finalize/${activeSarId}?auditor_id=${currentUser.username}`, { method: 'POST', headers: { "X-API-Key": API_KEY } });
            alert("Report Finalized and Archived.");
            closeModal();
            loadAuditQueue();
        }

        function closeModal() { document.getElementById('review-modal').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; }
        function closePanel() { document.getElementById('side-panel').classList.remove('open'); currentCase = null; }
        function getRiskStyle(r) { return r === 'HIGH' ? 'background:#fee2e2;color:#991b1b;' : r === 'MEDIUM' ? 'background:#fff3cd;color:#856404;' : 'background:#d4edda;color:#155724;'; }
    </script>
</body>

</html>